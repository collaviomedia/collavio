<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collavio Portfolio Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display.swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-input {
            transition: all 0.2s ease;
        }
        .form-input:focus {
            border-color: #7c3aed;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
            outline: none;
        }
        /* Dynamic Card Style for Preview */
        .dynamic-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ========== LOGIN SCREEN ========== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-900">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h1 class="text-3xl font-bold text-center mb-6">Collavio Admin</h1>
            <p class="text-center text-gray-600 mb-4">Portfolio Manager</p>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" class="form-input mt-1 block w-full rounded-lg border-gray-300" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-lg hover:bg-purple-700 transition-colors">
                        Login
                    </button>
                    <p id="login-error" class="text-red-500 text-sm hidden">Incorrect password.</p>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== ADMIN PANEL (Hidden) ========== -->
    <div id="admin-panel" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="container mx-auto max-w-7xl px-6 py-4 flex justify-between items-center">
                <h1 class="text-3xl font-bold">Portfolio Manager</h1>
                <p id="save-status" class="text-lg text-green-600 font-medium"></p>
            </div>
        </header>

        <main class="container mx-auto max-w-7xl px-6 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- === ADD/EDIT/PREVIEW COLUMN === -->
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4" id="form-title">Add New Project</h2>
                        <form id="project-form" class="space-y-4">
                            <div>
                                <label for="project-title" class="block text-sm font-medium text-gray-700">Project Title</label>
                                <input type="text" id="project-title" class="form-input mt-1 block w-full rounded-lg border-gray-300" required>
                            </div>
                            <div>
                                <label for="project-category" class="block text-sm font-medium text-gray-700">Category (e.g., "Tech Launch")</label>
                                <input type="text" id="project-category" class="form-input mt-1 block w-full rounded-lg border-gray-300" required>
                            </div>
                            <div>
                                <label for="project-image-url" class="block text-sm font-medium text-gray-700">Image URL</label>
                                <input type="url" id="project-image-url" class="form-input mt-1 block w-full rounded-lg border-gray-300" placeholder="https://..." required>
                            </div>
                            <div>
                                <label for="project-description" class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea id="project-description" rows="4" class="form-input mt-1 block w-full rounded-lg border-gray-300" required></textarea>
                            </div>
                            <button type="submit" id="submit-project-button" class="w-full bg-purple-600 text-white font-semibold py-3 rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400">
                                Add Project
                            </button>
                            <button type="button" id="cancel-edit-button" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg hover:bg-gray-700 transition-colors hidden">
                                Cancel Edit
                            </button>
                        </form>
                    </div>

                    <!-- === PREVIEW CARD === -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Live Preview</h2>
                        <div id="preview-card" class="bg-white rounded-2xl overflow-hidden dynamic-card">
                            <img id="preview-image" src="https://placehold.co/600x400/e9d5ff/7c3aed?text=Your+Image+Here&font=inter" alt="Preview" class="w-full h-60 object-cover">
                            <div class="p-6">
                                <p id="preview-category" class="text-sm text-purple-600 font-semibold mb-1">Category</p>
                                <h3 id="preview-title" class="text-xl font-bold mb-3">Project Title</h3>
                                <p id="preview-description" class="text-gray-600 text-sm">Your description will appear here.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- === EXISTING PROJECTS COLUMN === -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Existing Projects</h2>
                    <div id="existing-projects-list" class="space-y-6">
                        <!-- Skeletons for loading -->
                        <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg animate-pulse">
                            <div class="w-24 h-16 bg-gray-300 rounded-lg"></div>
                            <div class="flex-1 space-y-2">
                                <div class="w-3/4 h-5 bg-gray-300 rounded"></div>
                                <div class="w-1/2 h-4 bg-gray-300 rounded"></div>
                            </div>
                        </div>
                    </div>
                    <p id="portfolio-empty-message" class="text-center text-gray-500 text-lg hidden">
                        No projects found. Add one using the form!
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- ========== JAVASCRIPT & FIREBASE ========== -->
    <script type="module">
        // Import Firebase modules (v12.6.0 as requested)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        // REMOVED getAuth and signInAnonymously
        import { getFirestore, doc, collection, addDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // --- 1. FIREBASE CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDwvZMoUl242mEiWuB8dh1bnQEYJ6QIGow",
            authDomain: "collavio-12844.firebaseapp.com",
            databaseURL: "https://collavio-12844-default-rtdb.firebaseio.com",
            projectId: "collavio-12844",
            storageBucket: "collavio-12844.firebasestorage.app",
            messagingSenderId: "411900416052",
            appId: "1:411900416052:web:88ed561a1dde6a04337a61",
            measurementId: "G-GTP7BLNCMF"
        };
        
        let db, appId, portfolioCollectionRef;
        let currentEditId = null; // State variable to track editing

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            appId = firebaseConfig.appId || 'default-app-id';
            
            // This is the collection we will read from and write to
            portfolioCollectionRef = collection(db, `artifacts/${appId}/public/data/collavio-portfolio`);

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            alert("Could not connect to Firebase. Check console.");
        }

        // --- 2. LOGIN LOGIC ---
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        // *** YOUR ADMIN PASSWORD ***
        const ADMIN_PASSWORD = "collavioadmin"; // You can change this

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;

            if (password === ADMIN_PASSWORD) {
                loginScreen.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                // **FIX: Just call loadProjects() directly. No Firebase Auth needed.**
                loadProjects();
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // --- 3. ADMIN PANEL LOGIC ---
        const saveStatus = document.getElementById('save-status');
        const projectForm = document.getElementById('project-form');
        const submitProjectButton = document.getElementById('submit-project-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const formTitle = document.getElementById('form-title');
        const existingProjectsList = document.getElementById('existing-projects-list');
        const emptyMessage = document.getElementById('portfolio-empty-message');

        // Form fields
        const titleInput = document.getElementById('project-title');
        const categoryInput = document.getElementById('project-category');
        const imageUrlInput = document.getElementById('project-image-url');
        const descriptionInput = document.getElementById('project-description');

        // Preview fields
        const previewTitle = document.getElementById('preview-title');
        const previewCategory = document.getElementById('preview-category');
        const previewImage = document.getElementById('preview-image');
        const previewDescription = document.getElementById('preview-description');
        
        // Store all projects to easily find data for editing
        let allProjects = {};

        // Update preview as user types
        titleInput.addEventListener('input', () => previewTitle.textContent = titleInput.value || 'Project Title');
        categoryInput.addEventListener('input', () => previewCategory.textContent = categoryInput.value || 'Category');
        descriptionInput.addEventListener('input', () => previewDescription.textContent = descriptionInput.value || 'Your description will appear here.');
        imageUrlInput.addEventListener('input', () => {
            if (imageUrlInput.value) {
                previewImage.src = imageUrlInput.value;
            } else {
                previewImage.src = 'https://placehold.co/600x400/e9d5ff/7c3aed?text=Your+Image+Here&font=inter';
            }
        });
        
        // Reset form and preview
        function resetForm() {
            projectForm.reset();
            currentEditId = null;
            formTitle.textContent = 'Add New Project';
            submitProjectButton.textContent = 'Add Project';
            cancelEditButton.classList.add('hidden');
            // Reset preview
            previewTitle.textContent = 'Project Title';
            previewCategory.textContent = 'Category';
            previewDescription.textContent = 'Your description will appear here.';
            previewImage.src = 'https://placehold.co/600x400/e9d5ff/7c3aed?text=Your+Image+Here&font=inter';
        }
        
        cancelEditButton.addEventListener('click', resetForm);

        // Load existing projects from Firestore
        function loadProjects() {
            onSnapshot(portfolioCollectionRef, (snapshot) => {
                allProjects = {}; // Clear local cache
                if (snapshot.empty) {
                    existingProjectsList.innerHTML = '';
                    emptyMessage.classList.remove('hidden');
                    return;
                }

                existingProjectsList.innerHTML = '';
                emptyMessage.classList.add('hidden');

                snapshot.docs.forEach(doc => {
                    const project = doc.data();
                    const projectId = doc.id;
                    allProjects[projectId] = project; // Save for editing
                    
                    const projectEl = document.createElement('div');
                    projectEl.className = "flex items-center space-x-4 p-4 border border-gray-200 rounded-lg";
                    
                    projectEl.innerHTML = `
                        <img src="${project.imageUrl || 'https://placehold.co/100x100'}" alt="${project.title}" class="w-24 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-bold text-gray-900 truncate">${project.title}</p>
                            <p class="text-sm text-gray-500 truncate">${project.category}</p>
                        </div>
                        <button class="edit-btn text-blue-500 hover:text-blue-700" data-id="${projectId}">
                            <i data-lucide="edit-2" class="w-5 h-5"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700" data-id="${projectId}">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    
                    existingProjectsList.appendChild(projectEl);
                });

                // Add delete functionality
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', async () => {
                        const id = button.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this project?')) {
                            try {
                                const docRef = doc(db, `artifacts/${appId}/public/data/collavio-portfolio`, id);
                                await deleteDoc(docRef);
                                showStatus('Project deleted!', 'green');
                            } catch (error) {
                                console.error("Error deleting document:", error);
                                showStatus('Error deleting project.', 'red');
                            }
                        }
                    });
                });
                
                // Add EDIT functionality
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.getAttribute('data-id');
                        const project = allProjects[id];
                        if (!project) return;
                        
                        // Set editing state
                        currentEditId = id;
                        
                        // Fill the form
                        titleInput.value = project.title;
                        categoryInput.value = project.category;
                        imageUrlInput.value = project.imageUrl;
                        descriptionInput.value = project.description;
                        
                        // Update preview
                        previewTitle.textContent = project.title;
                        previewCategory.textContent = project.category;
                        previewImage.src = project.imageUrl;
                        previewDescription.textContent = project.description;
                        
                        // Update UI
                        formTitle.textContent = 'Edit Project';
                        submitProjectButton.textContent = 'Update Project';
                        cancelEditButton.classList.remove('hidden');
                        
                        // Scroll to top
                        window.scrollTo(0, 0);
                    });
                });

                lucide.createIcons();
            }, (error) => {
                console.error("Error loading projects: ", error);
                existingProjectsList.innerHTML = `<p class="text-red-500">Error loading projects. Did you set the Firestore rules?</p>`;
            });
        }

        // Handle Add/Edit form submission
        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitProjectButton.disabled = true;
            
            const projectData = {
                title: titleInput.value,
                category: categoryInput.value,
                imageUrl: imageUrlInput.value,
                description: descriptionInput.value,
                createdAt: new Date() // Always update timestamp
            };

            try {
                if (currentEditId) {
                    // --- UPDATE (EDIT) existing project ---
                    submitProjectButton.textContent = 'Updating...';
                    const docRef = doc(db, `artifacts/${appId}/public/data/collavio-portfolio`, currentEditId);
                    await setDoc(docRef, projectData, { merge: true }); // Use setDoc with merge to update
                    showStatus('Project updated successfully!', 'green');
                } else {
                    // --- ADD new project ---
                    submitProjectButton.textContent = 'Adding...';
                    await addDoc(portfolioCollectionRef, projectData);
                    showStatus('Project added successfully!', 'green');
                }
                resetForm(); // Reset form after success
            } catch (error) {
                console.error("Error writing document: ", error);
                showStatus('Error saving project.', 'red');
            }

            submitProjectButton.disabled = false;
        });

        // Show status message
        function showStatus(message, color) {
            saveStatus.textContent = message;
            saveStatus.style.color = color;
            setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);
        }
        
        // Init icons on load
        lucide.createIcons();
    </script>
</body>
</html>